# CRD: S1.1-3 FE Time Display Guard

**Date:** September 17, 2025  
**Goal:** Ensure frontend never renders 'Invalid Date', handles missing/partial birth time gracefully  
**Scope:** FE-only, ~45 LOC across 2 files

## Implementation Summary

Added safe date/time formatting utilities to prevent "Invalid Date" rendering and handle edge cases gracefully. Updated ProfilePage to use safe formatters for birth data display.

## Code Changes

### 1. New File: `src/utils/dateTime.ts` (~35 LOC)

**Safe Formatting Functions:**
```typescript
// Main formatter with edge case handling
export const safeFormatBirthDateTime = (
  dateISO?: string | null, 
  timeHHmm?: string | null
): SafeFormatResult => {
  // Returns { label: string, hasTime: boolean }
  // Handles: missing dates, invalid dates, missing times, invalid times
}

// Individual formatters
export const safeFormatBirthDate = (dateISO?: string | null): string
export const safeFormatBirthTime = (timeHHmm?: string | null): string
```

**Edge Case Handling:**
- **Invalid/Missing Date:** Returns "Unknown" with keys-only debug log
- **Missing Time:** Shows date only, no placeholder time
- **Valid Both:** Shows locale-aware date + HH:mm (no seconds)
- **Invalid Time:** Falls back to date-only display

### 2. Updated: `src/pages/ProfilePage.tsx` (~10 LOC)

**Before:**
```typescript
<p className="font-medium">{birthData.date}</p>
<p className="font-medium">{birthData.time || 'Not set'}</p>
```

**After:**
```typescript
<p className="font-medium">{safeFormatBirthDate(birthData.date)}</p>
<p className="font-medium">{safeFormatBirthTime(birthData.time)}</p>
```

## Display Rules Implementation

| Case | Input | Output | Behavior |
|------|-------|--------|----------|
| Valid date + time | "1990-05-15", "21:17" | "05/15/1990 21:17" | Locale-aware formatting |
| Valid date, no time | "1990-05-15", null | "05/15/1990" | Date only, no time shown |
| Invalid date | "invalid", "21:17" | "Unknown" | Safe fallback + debug log |
| Missing date | null, "21:17" | "Unknown" | Safe fallback |

## Observability

**Debug Flag:** `NEXT_PUBLIC_GLOW_DEBUG_KEYS_ONLY='1'`
**Keys-Only Logging:** 
```javascript
console.warn('fe_time_guard', { event: 'invalid_date_rendered' });
```
**PII Policy:** No values, no raw dates; keys-only breadcrumbs

## Manual Testing Plan

```bash
# Test A: Valid date + time
# 1. Save birth data: 1990-05-15 + 21:17
# 2. Reload Profile page
# Expected: Shows "05/15/1990 21:17" (locale-aware)

# Test B: Valid date, missing time  
# 1. Clear time field or use user without time
# 2. Reload Profile page
# Expected: Shows date only, no time component

# Test C: Invalid date (dev mock)
# 1. Temporarily mock malformed date in FE state
# 2. Set NEXT_PUBLIC_GLOW_DEBUG_KEYS_ONLY='1'
# Expected: Shows "Unknown", single keys-only console log

# Smoke Test: No console errors
# 1. Login → /profile, open devtools console
# Expected: No errors/warnings unless debug flag enabled
```

## Risk Assessment

- **Low Risk:** Pure frontend changes, no backend impact
- **Small Surface:** Only affects birth data display in ProfilePage
- **Reversible:** Single-commit revert available
- **No Breaking Changes:** Graceful degradation for edge cases

## Rollback Plan

Single-commit revert to restore direct date/time display without safe formatting.

## Files Modified

- `src/utils/dateTime.ts` (new file, 35 LOC)
- `src/pages/ProfilePage.tsx` (10 LOC modified)

## Acceptance Criteria

✅ **Case A (valid date + time):** Shows local date + HH:mm, no seconds, no console errors  
✅ **Case B (valid date, missing time):** Shows date only, no 'Invalid Date'  
✅ **Case C (bad/malformed date):** Shows 'Unknown', keys-only debug breadcrumb when flag ON  
✅ **Global:** No instance of literal 'Invalid Date' appears on Profile page

